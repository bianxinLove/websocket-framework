# WebSocketæ¡†æ¶å­¦ä¹ æŒ‡å—

## ç›®å½•
- [å­¦ä¹ ä»·å€¼æ¦‚è¿°](#å­¦ä¹ ä»·å€¼æ¦‚è¿°)
- [æ ¸å¿ƒå­¦ä¹ è¦ç‚¹](#æ ¸å¿ƒå­¦ä¹ è¦ç‚¹)
- [è¯¦ç»†å­¦ä¹ å†…å®¹](#è¯¦ç»†å­¦ä¹ å†…å®¹)
- [å®è·µå»ºè®®](#å®è·µå»ºè®®)
- [è¿›é˜¶å­¦ä¹ è·¯å¾„](#è¿›é˜¶å­¦ä¹ è·¯å¾„)

---

## å­¦ä¹ ä»·å€¼æ¦‚è¿°

è¿™ä¸ªWebSocketæ¡†æ¶é¡¹ç›®æ˜¯ä¸€ä¸ª**ä¼ä¸šçº§å®æˆ˜é¡¹ç›®**ï¼Œé›†æˆäº†ç°ä»£Javaå¼€å‘çš„å¤šç§æœ€ä½³å®è·µã€‚é€šè¿‡å­¦ä¹ è¿™ä¸ªé¡¹ç›®ï¼Œä½ å¯ä»¥æŒæ¡ä»åŸºç¡€çš„WebSocketç¼–ç¨‹åˆ°é«˜çº§çš„åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡çš„å„ç§æŠ€èƒ½ã€‚

### é¡¹ç›®æŠ€æœ¯å«é‡è¯„ä¼°
- **éš¾åº¦ç­‰çº§**: â­â­â­â­â­ (5/5)
- **å®ç”¨ä»·å€¼**: â­â­â­â­â­ (5/5)
- **å­¦ä¹ æ”¶ç›Š**: â­â­â­â­â­ (5/5)

---

## æ ¸å¿ƒå­¦ä¹ è¦ç‚¹

### 1. ğŸ”§ **WebSocketæ ¸å¿ƒæŠ€æœ¯**
- Java WebSocket APIçš„ä¼ä¸šçº§åº”ç”¨
- è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†
- å¿ƒè·³æ£€æµ‹æœºåˆ¶è®¾è®¡

### 2. ğŸ—ï¸ **æ¶æ„è®¾è®¡æ¨¡å¼**
- äº‹ä»¶é©±åŠ¨æ¶æ„(Event-Driven Architecture)
- é™æ€ä¾èµ–æ³¨å…¥è§£å†³æ–¹æ¡ˆ
- å¤šå±‚çº§ä¼šè¯ç®¡ç†è®¾è®¡

### 3. ğŸš€ **å¹¶å‘ç¼–ç¨‹å®æˆ˜**
- è‡ªå®šä¹‰çº¿ç¨‹å®‰å…¨æ•°æ®ç»“æ„
- ä»»åŠ¡è¶…æ—¶æ§åˆ¶æœºåˆ¶
- æ™ºèƒ½çº¿ç¨‹æ± ç®¡ç†

### 4. ğŸ“Š **ç³»ç»Ÿç›‘æ§ä¸è¿ç»´**
- è‡ªé€‚åº”ç›‘æ§ç³»ç»Ÿè®¾è®¡
- JVMå†…ç½®å·¥å…·çš„é«˜æ•ˆä½¿ç”¨
- å†…å­˜å‹åŠ›ç›‘æ§ä¸å¤„ç†

### 5. ğŸ”’ **åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡**
- Redisåˆ†å¸ƒå¼ç¼“å­˜åº”ç”¨
- é›†ç¾¤éƒ¨ç½²ä¼šè¯åŒæ­¥
- åˆ†å¸ƒå¼å¿ƒè·³ç®¡ç†

### 6. âš™ï¸ **Spring Booté«˜çº§åº”ç”¨**
- è‡ªå®šä¹‰é…ç½®å±æ€§ç®¡ç†
- æ¡ä»¶è£…é…ä¸è‡ªåŠ¨é…ç½®
- äº‹ä»¶å‘å¸ƒè®¢é˜…æœºåˆ¶

### 7. ğŸ¯ **ä»£ç è´¨é‡ä¸æœ€ä½³å®è·µ**
- å¼‚å¸¸å¤„ç†ç­–ç•¥
- æ—¥å¿—è®°å½•è§„èŒƒ
- ä»£ç ç»„ç»‡ç»“æ„

---

## è¯¦ç»†å­¦ä¹ å†…å®¹

### 1. WebSocketæ ¸å¿ƒæŠ€æœ¯ ğŸ”§

#### å­¦ä¹ äº®ç‚¹åˆ†æ

**æ ¸å¿ƒæ–‡ä»¶**: `WebSocketServer.java:35-457`

#### äº®ç‚¹1: é™æ€ä¾èµ–æ³¨å…¥è§£å†³WebSocketç«¯ç‚¹å®ä¾‹åŒ–é—®é¢˜
```java
// é—®é¢˜ï¼šWebSocketç«¯ç‚¹ç”±å®¹å™¨ç›´æ¥å®ä¾‹åŒ–ï¼ŒSpringæ— æ³•æ³¨å…¥ä¾èµ–
@ServerEndpoint(value = "/websocket/connect/{service}/{userId}")
public class WebSocketServer {
    
    // è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨é™æ€å­—æ®µ + é™æ€setteræ–¹æ³•
    private static WebSocketSessionManager sessionManager;
    
    @Autowired
    public void setSessionManager(WebSocketSessionManager sessionManager) {
        WebSocketServer.sessionManager = sessionManager;
    }
}
```

**å­¦ä¹ ä»·å€¼**:
- ç†è§£WebSocketç«¯ç‚¹å®ä¾‹åŒ–æœºåˆ¶çš„é™åˆ¶
- æŒæ¡åœ¨éSpringç®¡ç†å¯¹è±¡ä¸­ä½¿ç”¨Spring Beançš„æŠ€å·§
- å­¦ä¼šè§£å†³å®¹å™¨å®ä¾‹åŒ–ä¸ä¾èµ–æ³¨å…¥å†²çªçš„é—®é¢˜

#### äº®ç‚¹2: æ™ºèƒ½å¿ƒè·³æ£€æµ‹æœºåˆ¶
```java
// å¿ƒè·³è¶…æ—¶æ—¶é—´åŸå­æ“ä½œç®¡ç†
private final AtomicLong nextHeartbeatTimeout = new AtomicLong(0);

// ä½¿ç”¨è¶…æ—¶ä¿æŠ¤å‘é€å¿ƒè·³
private void sendHeartbeatWithTimeout(String taskName) {
    if (timeoutTaskWrapper != null) {
        timeoutTaskWrapper.executeWithTimeout(this::sendHeartbeat, taskName);
    } else {
        sendHeartbeat(); // é™çº§ç­–ç•¥
    }
}
```

**å­¦ä¹ ä»·å€¼**:
- å­¦ä¹ å¦‚ä½•è®¾è®¡å¯é çš„å¿ƒè·³æ£€æµ‹æœºåˆ¶
- ç†è§£åŸå­æ“ä½œåœ¨å¹¶å‘åœºæ™¯ä¸‹çš„åº”ç”¨
- æŒæ¡é™çº§ç­–ç•¥çš„è®¾è®¡æ€è·¯

#### äº®ç‚¹3: å®Œæ•´çš„WebSocketç”Ÿå‘½å‘¨æœŸç®¡ç†
```java
@OnOpen
public void onOpen(Session session, @PathParam("service") String service, @PathParam("userId") String userId) {
    try {
        // 1. åˆ›å»ºä¼šè¯åŒ…è£…
        this.webSocketSession = new WebSocketSession(session, userId, service);
        
        // 2. æ·»åŠ åˆ°ä¼šè¯ç®¡ç†å™¨
        sessionManager.addSession(service, userId, webSocketSession);
        
        // 3. å¯åŠ¨å¿ƒè·³æ£€æµ‹
        startHeartbeat();
        
        // 4. å‘å¸ƒè¿æ¥å»ºç«‹äº‹ä»¶
        WebSocketEvent<String> event = WebSocketEvent.onOpen(/*...*/);
        eventBus.post(event);
        
    } catch (Exception e) {
        // å¼‚å¸¸å¤„ç†å’Œäº‹ä»¶å‘å¸ƒ
    }
}
```

**å­¦ä¹ ä»·å€¼**:
- æŒæ¡WebSocketå®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸå¤„ç†
- å­¦ä¹ å¼‚å¸¸å®‰å…¨çš„ç¼–ç¨‹æ¨¡å¼
- ç†è§£äº‹ä»¶é©±åŠ¨ç¼–ç¨‹çš„å®é™…åº”ç”¨

### 2. æ¶æ„è®¾è®¡æ¨¡å¼ ğŸ—ï¸

#### å­¦ä¹ äº®ç‚¹åˆ†æ

**æ ¸å¿ƒæ–‡ä»¶**: `WebSocketEventBus.java`, `WebSocketMessageHandlerDispatcher.java`

#### äº®ç‚¹1: äº‹ä»¶é©±åŠ¨æ¶æ„çš„å®Œæ•´å®ç°
```java
// äº‹ä»¶æ€»çº¿ - è§£è€¦äº‹ä»¶äº§ç”Ÿè€…å’Œæ¶ˆè´¹è€…
@Component
public class WebSocketEventBus {
    private EventBus eventBus;
    
    @PostConstruct
    public void initialize() {
        this.eventBus = new AsyncEventBus("WebSocketEventBus", executorService);
    }
    
    public void post(Object event) {
        eventBus.post(event);
    }
}

// äº‹ä»¶åˆ†å‘å™¨ - ç»Ÿä¸€å¤„ç†æ‰€æœ‰WebSocketäº‹ä»¶
@Component
public class WebSocketMessageHandlerDispatcher {
    
    @Subscribe
    public void handleWebSocketEvent(WebSocketEvent<?> event) {
        // 1. æ‰¾åˆ°æ”¯æŒæ­¤äº‹ä»¶çš„å¤„ç†å™¨
        List<WebSocketMessageHandler<?>> supportedHandlers = /*...*/;
        
        // 2. åº”ç”¨æ‹¦æˆªå™¨é“¾
        List<WebSocketEventInterceptor> sortedInterceptors = getSortedInterceptors();
        
        // 3. æ‰§è¡Œå¤„ç†å™¨
        for (WebSocketMessageHandler<?> handler : supportedHandlers) {
            processWithHandler(handler, event, sortedInterceptors);
        }
    }
}
```

**å­¦ä¹ ä»·å€¼**:
- ç†è§£äº‹ä»¶é©±åŠ¨æ¶æ„çš„è®¾è®¡åŸç†å’Œå®ç°æ–¹å¼
- å­¦ä¹ å¦‚ä½•ä½¿ç”¨Google Guava EventBusæ„å»ºå¼‚æ­¥äº‹ä»¶ç³»ç»Ÿ
- æŒæ¡è´£ä»»é“¾æ¨¡å¼åœ¨æ‹¦æˆªå™¨è®¾è®¡ä¸­çš„åº”ç”¨
- å­¦ä¼šå¦‚ä½•è®¾è®¡å¯æ‰©å±•çš„äº‹ä»¶å¤„ç†ç³»ç»Ÿ

#### äº®ç‚¹2: æ‹¦æˆªå™¨é“¾æ¨¡å¼çš„å®Œæ•´å®ç°
```java
private void processWithHandler(WebSocketMessageHandler<?> handler, WebSocketEvent<?> event, 
                               List<WebSocketEventInterceptor> interceptors) {
    try {
        // å‰ç½®æ‹¦æˆªå™¨å¤„ç†
        if (!applyPreInterceptors(interceptors, event)) {
            return; // æ‹¦æˆªå™¨ä¸­æ–­å¤„ç†
        }

        // æ‰§è¡Œå®é™…çš„äº‹ä»¶å¤„ç†
        result = handler.handleEvent(event);
        
        // åç½®æ‹¦æˆªå™¨å¤„ç†
        applyPostInterceptors(interceptors, event, result);

    } catch (Exception e) {
        exception = e;
    } finally {
        // å®Œæˆæ‹¦æˆªå™¨å¤„ç†
        applyAfterCompletionInterceptors(interceptors, event, result, exception);
    }
}
```

**å­¦ä¹ ä»·å€¼**:
- å­¦ä¹ æ‹¦æˆªå™¨é“¾æ¨¡å¼çš„æ ‡å‡†å®ç°
- ç†è§£AOPæ€æƒ³åœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨
- æŒæ¡å¼‚å¸¸å®‰å…¨çš„ç¼–ç¨‹æŠ€å·§
- å­¦ä¼šè®¾è®¡å¯æ’æ‹”çš„åŠŸèƒ½æ‰©å±•ç‚¹

#### äº®ç‚¹3: å¤šå±‚çº§ä¼šè¯ç®¡ç†è®¾è®¡
```java
// è‡ªå®šä¹‰åŒå±‚å¹¶å‘æ˜ å°„ - service -> userId -> session
private static class ConcurrentBiMap<K1, K2, V> {
    private final ConcurrentHashMap<K1, ConcurrentHashMap<K2, V>> innerMap = new ConcurrentHashMap<>();
    
    public V remove(K1 key1, K2 key2) {
        ConcurrentHashMap<K2, V> subMap = innerMap.get(key1);
        if (subMap != null) {
            V removed = subMap.remove(key2);
            if (subMap.isEmpty()) {
                synchronized (innerMap) {
                    ConcurrentHashMap<K2, V> recheckedSubMap = innerMap.get(key1);
                    if (recheckedSubMap != null && recheckedSubMap.isEmpty()) {
                        innerMap.remove(key1);
                    }
                }
            }
            return removed;
        }
        return null;
    }
}
```

**å­¦ä¹ ä»·å€¼**:
- å­¦ä¹ å¦‚ä½•è®¾è®¡å¤æ‚çš„çº¿ç¨‹å®‰å…¨æ•°æ®ç»“æ„
- ç†è§£åŒé‡æ£€æŸ¥é”å®šæ¨¡å¼çš„åº”ç”¨åœºæ™¯
- æŒæ¡å†…å­˜æ³„æ¼é¢„é˜²çš„ç¼–ç¨‹æŠ€å·§
- å­¦ä¼šæ€§èƒ½ä¼˜åŒ–ä¸å†…å­˜ç®¡ç†çš„å¹³è¡¡

### 3. å¹¶å‘ç¼–ç¨‹å®æˆ˜ ğŸš€

#### å­¦ä¹ äº®ç‚¹åˆ†æ

**æ ¸å¿ƒæ–‡ä»¶**: `TimeoutTaskWrapper.java`, `WebSocketFrameworkConfig.java`

#### äº®ç‚¹1: æ™ºèƒ½ä»»åŠ¡è¶…æ—¶æ§åˆ¶æœºåˆ¶
```java
public class TimeoutTaskWrapper {
    
    // ä½¿ç”¨å•ç‹¬çš„ç›‘æ§çº¿ç¨‹æ± ï¼Œé¿å…å ç”¨ä¸»çº¿ç¨‹æ± èµ„æº
    private final ScheduledExecutorService monitorExecutor;
    
    public CompletableFuture<Void> executeWithTimeout(Runnable task, String taskName) {
        // åˆ›å»ºå¯ä¸­æ–­çš„ä»»åŠ¡åŒ…è£…å™¨
        InterruptibleTaskWrapper wrapper = new InterruptibleTaskWrapper(task, taskName, startTime);
        
        CompletableFuture<Void> future = CompletableFuture.runAsync(wrapper, executor);
        
        // ä½¿ç”¨ç‹¬ç«‹çš„ç›‘æ§çº¿ç¨‹æ± è¿›è¡Œè¶…æ—¶ç›‘æ§
        ScheduledFuture<?> timeoutFuture = monitorExecutor.schedule(() -> {
            if (!future.isDone()) {
                // 1. è®¾ç½®ä¸­æ–­æ ‡å¿—
                wrapper.markAsTimedOut();
                // 2. å°è¯•å–æ¶ˆä»»åŠ¡
                future.cancel(true);
                // 3. å»¶è¿Ÿæ£€æŸ¥ä»»åŠ¡æ˜¯å¦çœŸæ­£åœæ­¢
                monitorExecutor.schedule(() -> {
                    if (!future.isDone()) {
                        log.error("ä»»åŠ¡è¶…æ—¶åä»åœ¨æ‰§è¡Œ: task={}", taskName);
                    }
                }, 5, TimeUnit.SECONDS);
            }
        }, timeoutSeconds, TimeUnit.SECONDS);
        
        return future;
    }
}
```

**å­¦ä¹ ä»·å€¼**:
- å­¦ä¹ å¦‚ä½•è®¾è®¡å¯é çš„ä»»åŠ¡è¶…æ—¶æ§åˆ¶æœºåˆ¶
- ç†è§£CompletableFutureçš„é«˜çº§ç”¨æ³•
- æŒæ¡çº¿ç¨‹æ± èµ„æºéš”ç¦»çš„è®¾è®¡æ€è·¯
- å­¦ä¼šå¤„ç†ä¸å¯ä¸­æ–­ä»»åŠ¡çš„æ–¹æ³•

#### äº®ç‚¹2: æ™ºèƒ½çº¿ç¨‹æ± è®¾è®¡
```java
public static class OptimizedScheduledThreadPoolExecutor extends ScheduledThreadPoolExecutor {
    
    private final AtomicLong totalTasks = new AtomicLong(0);
    private final AtomicLong rejectedTasks = new AtomicLong(0);
    
    @Override
    protected void afterExecute(Runnable r, Throwable t) {
        super.afterExecute(r, t);
        // åªåœ¨å¼‚å¸¸æƒ…å†µä¸‹è®°å½•æ—¥å¿—ï¼Œé¿å…æ€§èƒ½å¼€é”€
        if (t != null) {
            log.warn("ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸", t);
        }
    }
    
    // è·å–ä»»åŠ¡ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¾›å¤–éƒ¨ç›‘æ§ä½¿ç”¨ï¼‰
    public TaskStatistics getTaskStatistics() {
        return new TaskStatistics(
            totalTasks.get(),
            rejectedTasks.get(), 
            getCompletedTaskCount(),
            getActiveCount(),
            getQueue().size()
        );
    }
}
```

**å­¦ä¹ ä»·å€¼**:
- å­¦ä¹ å¦‚ä½•æ‰©å±•Javaæ ‡å‡†çº¿ç¨‹æ± 
- ç†è§£çº¿ç¨‹æ± ç›‘æ§æŒ‡æ ‡çš„è®¾è®¡
- æŒæ¡æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§å¹³è¡¡çš„æŠ€å·§
- å­¦ä¼šè®¾è®¡å¯è§‚æµ‹çš„ç³»ç»Ÿç»„ä»¶

#### äº®ç‚¹3: æ™ºèƒ½æ‹’ç»ç­–ç•¥
```java
private class SmartRejectedExecutionHandler implements RejectedExecutionHandler {
    
    private final AtomicLong lastWarningTime = new AtomicLong(0);
    private static final long WARNING_INTERVAL = 60000; // 1åˆ†é’Ÿè­¦å‘Šé—´éš”
    
    @Override
    public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {
        // é™åˆ¶è­¦å‘Šé¢‘ç‡ï¼Œé¿å…æ—¥å¿—æ´ªæ°´
        long currentTime = System.currentTimeMillis();
        if (currentTime - lastWarningTime.get() > WARNING_INTERVAL) {
            lastWarningTime.set(currentTime);
            log.warn("çº¿ç¨‹æ± ä»»åŠ¡è¢«æ‹’ç»: æ´»è·ƒçº¿ç¨‹={}, é˜Ÿåˆ—å¤§å°={}", 
                executor.getActiveCount(), executor.getQueue().size());
        }
        
        // å°è¯•åœ¨è°ƒç”¨çº¿ç¨‹ä¸­æ‰§è¡Œï¼ˆé™çº§ç­–ç•¥ï¼‰
        if (!executor.isShutdown()) {
            try {
                r.run();
            } catch (Exception e) {
                throw new RejectedExecutionException("ä»»åŠ¡æ‰§è¡Œè¢«æ‹’ç»ä¸”è°ƒç”¨çº¿ç¨‹æ‰§è¡Œå¤±è´¥", e);
            }
        }
    }
}
```

**å­¦ä¹ ä»·å€¼**:
- å­¦ä¹ æ™ºèƒ½æ‹’ç»ç­–ç•¥çš„è®¾è®¡æ€è·¯
- ç†è§£é™çº§å¤„ç†çš„é‡è¦æ€§
- æŒæ¡æ—¥å¿—é¢‘ç‡æ§åˆ¶çš„æŠ€å·§
- å­¦ä¼šè®¾è®¡ç”¨æˆ·å‹å¥½çš„é”™è¯¯å¤„ç†

### 4. ç³»ç»Ÿç›‘æ§ä¸è¿ç»´ ğŸ“Š

#### å­¦ä¹ äº®ç‚¹åˆ†æ

**æ ¸å¿ƒæ–‡ä»¶**: `ThreadPoolMonitor.java`

#### äº®ç‚¹1: è‡ªé€‚åº”ç›‘æ§é¢‘ç‡è°ƒæ•´
```java
private void adjustMonitoringStrategy(ThreadPoolHealthStatus healthStatus, ThreadPoolMetrics metrics) {
    int newInterval = currentMonitorInterval;
    int newSamplingRate = samplingRate;
    
    switch (healthStatus) {
        case HEALTHY:
            // å¥åº·çŠ¶æ€ï¼šé™ä½ç›‘æ§é¢‘ç‡ï¼Œå‡å°‘å¼€é”€
            newInterval = Math.min(maxInterval, currentMonitorInterval + 10);
            newSamplingRate = Math.min(5, samplingRate + 1);
            break;
            
        case WARNING:
            // è­¦å‘ŠçŠ¶æ€ï¼šä¿æŒæ­£å¸¸ç›‘æ§é¢‘ç‡
            newInterval = initialInterval;
            newSamplingRate = 2;
            break;
            
        case CRITICAL:
            // ä¸¥é‡çŠ¶æ€ï¼šæé«˜ç›‘æ§é¢‘ç‡
            newInterval = Math.max(minInterval, currentMonitorInterval - 10);
            newSamplingRate = 1;
            break;
    }
    
    // å¹³æ»‘è°ƒæ•´ç›‘æ§å‚æ•°
    if (newInterval != currentMonitorInterval) {
        rescheduleMonitoring();
    }
}
```

**å­¦ä¹ ä»·å€¼**:
- å­¦ä¹ è‡ªé€‚åº”ç³»ç»Ÿçš„è®¾è®¡åŸç†
- ç†è§£ç›‘æ§ç³»ç»Ÿçš„æ€§èƒ½å¼€é”€æ§åˆ¶
- æŒæ¡çŠ¶æ€æœºåœ¨ç›‘æ§ç³»ç»Ÿä¸­çš„åº”ç”¨
- å­¦ä¼šè®¾è®¡æ™ºèƒ½åŒ–çš„è¿ç»´å·¥å…·

#### äº®ç‚¹2: å¤šç»´åº¦å¥åº·çŠ¶æ€è¯„ä¼°
```java
private ThreadPoolHealthStatus analyzeHealthStatus(ThreadPoolMetrics metrics) {
    // å¤šç»´åº¦å¥åº·è¯„ä¼°
    int healthScore = 100;
    
    // çº¿ç¨‹æ± åˆ©ç”¨ç‡è¯„ä¼°
    if (metrics.poolUtilization > 0.9) {
        healthScore -= 30;
    } else if (metrics.poolUtilization > 0.7) {
        healthScore -= 15;
    }
    
    // é˜Ÿåˆ—åˆ©ç”¨ç‡è¯„ä¼°
    if (metrics.queueUtilization > 0.8) {
        healthScore -= 25;
    } else if (metrics.queueUtilization > 0.5) {
        healthScore -= 10;
    }
    
    // ä»»åŠ¡ç§¯å‹è¯„ä¼°
    long pendingTasks = metrics.taskCount - metrics.completedTaskCount;
    if (pendingTasks > metrics.maximumPoolSize * 10) {
        healthScore -= 20;
    }
    
    // æ ¹æ®ç»¼åˆå¾—åˆ†åˆ¤æ–­å¥åº·çŠ¶æ€
    return healthScore >= 80 ? HEALTHY : 
           healthScore >= 60 ? WARNING : 
           healthScore >= 40 ? CRITICAL : EMERGENCY;
}
```

**å­¦ä¹ ä»·å€¼**:
- å­¦ä¹ å¤šç»´åº¦æŒ‡æ ‡ç»¼åˆè¯„ä¼°çš„æ–¹æ³•
- ç†è§£ç³»ç»Ÿå¥åº·çŠ¶æ€é‡åŒ–çš„æŠ€å·§
- æŒæ¡é˜ˆå€¼è®¾è®¡çš„æœ€ä½³å®è·µ
- å­¦ä¼šæ„å»ºå¯è§£é‡Šçš„ç›‘æ§ç³»ç»Ÿ

#### äº®ç‚¹3: JVMå†…ç½®å·¥å…·çš„é«˜æ•ˆä½¿ç”¨
```java
// å…¼å®¹æ€§è‰¯å¥½çš„CPUä½¿ç”¨ç‡è·å–
private double getProcessCpuLoad() {
    try {
        // æ£€æŸ¥æ˜¯å¦æ˜¯com.sun.management.OperatingSystemMXBeançš„å®ä¾‹
        if (osBean instanceof com.sun.management.OperatingSystemMXBean) {
            com.sun.management.OperatingSystemMXBean sunOsBean = 
                (com.sun.management.OperatingSystemMXBean) osBean;
            return sunOsBean.getProcessCpuLoad();
        }
    } catch (Exception e) {
        log.debug("æ— æ³•ç›´æ¥è·å–è¿›ç¨‹CPUä½¿ç”¨ç‡ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ");
    }
    
    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ç³»ç»Ÿè´Ÿè½½å¹³å‡å€¼ä¼°ç®—
    double systemLoadAverage = osBean.getSystemLoadAverage();
    int processors = osBean.getAvailableProcessors();
    return Math.min(1.0, systemLoadAverage / processors);
}
```

**å­¦ä¹ ä»·å€¼**:
- å­¦ä¹ JVMå†…ç½®ç›‘æ§å·¥å…·çš„ä½¿ç”¨æ–¹æ³•
- ç†è§£è·¨å¹³å°å…¼å®¹æ€§å¤„ç†çš„é‡è¦æ€§
- æŒæ¡é™çº§æ–¹æ¡ˆè®¾è®¡çš„æ€è·¯
- å­¦ä¼šç¼–å†™å¥å£®çš„ç³»ç»Ÿç›‘æ§ä»£ç 

### 5. åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡ ğŸ”’

#### å­¦ä¹ äº®ç‚¹åˆ†æ

**æ ¸å¿ƒæ–‡ä»¶**: `WebSocketSessionManager.java`

#### äº®ç‚¹1: Redisåˆ†å¸ƒå¼å¿ƒè·³ç®¡ç†
```java
// æ‰¹é‡æ›´æ–°å¿ƒè·³ï¼ˆå‡å°‘Redisç½‘ç»œå¼€é”€ï¼‰
public void batchUpdateHeartbeat(Map<String, Map<String, Integer>> serviceUserTimeouts) {
    try {
        long currentTime = System.currentTimeMillis();
        
        // ä½¿ç”¨Redis Pipelineæ‰¹é‡æ‰§è¡Œ
        redisTemplate.executePipelined((RedisCallback<?>) (connection) -> {
            for (Map.Entry<String, Map<String, Integer>> serviceEntry : serviceUserTimeouts.entrySet()) {
                String service = serviceEntry.getKey();
                for (Map.Entry<String, Integer> userEntry : serviceEntry.getValue().entrySet()) {
                    String userId = userEntry.getKey();
                    int timeoutSeconds = userEntry.getValue();
                    String cacheKey = getHeartbeatCacheKey(service, userId);
                    
                    // æ‰¹é‡è®¾ç½®
                    connection.setEx(cacheKey.getBytes(), timeoutSeconds, 
                                   String.valueOf(currentTime).getBytes());
                }
            }
            return null;
        });
    } catch (Exception e) {
        log.error("æ‰¹é‡æ›´æ–°å¿ƒè·³å¤±è´¥", e);
    }
}
```

**å­¦ä¹ ä»·å€¼**:
- å­¦ä¹ Redis Pipelineçš„æ­£ç¡®ä½¿ç”¨æ–¹æ³•
- ç†è§£åˆ†å¸ƒå¼ç¼“å­˜çš„æ‰¹é‡æ“ä½œä¼˜åŒ–
- æŒæ¡ç½‘ç»œå¼€é”€ä¸æ€§èƒ½ä¼˜åŒ–çš„å¹³è¡¡
- å­¦ä¼šè®¾è®¡é«˜æ•ˆçš„åˆ†å¸ƒå¼æ•°æ®åŒæ­¥æœºåˆ¶

#### äº®ç‚¹2: åˆ†å¸ƒå¼ä¼šè¯ä¸€è‡´æ€§ä¿éšœ
```java
public boolean isOnline(String service, String userId) {
    // é¦–å…ˆæ£€æŸ¥æœ¬åœ°ä¼šè¯æ± ï¼ˆæ›´å¿«ï¼‰
    if (sessionPool.get(service, userId) != null) {
        return true;
    }
    
    // å¦‚æœæœ¬åœ°æ²¡æœ‰ï¼Œå†æ£€æŸ¥Redisï¼ˆåˆ†å¸ƒå¼åœºæ™¯ï¼‰
    String cacheKey = getHeartbeatCacheKey(service, userId);
    return redisTemplate.hasKey(cacheKey);
}

public void updateHeartbeat(String service, String userId, int timeoutSeconds) {
    String cacheKey = getHeartbeatCacheKey(service, userId);
    
    // ä½¿ç”¨Redisçš„SETEXå‘½ä»¤ï¼ŒåŸå­æ€§è®¾ç½®å€¼å’ŒTTL
    long currentTime = System.currentTimeMillis();
    redisTemplate.opsForValue().set(cacheKey, currentTime, timeoutSeconds, TimeUnit.SECONDS);
}
```

**å­¦ä¹ ä»·å€¼**:
- å­¦ä¹ æœ¬åœ°ç¼“å­˜ä¸åˆ†å¸ƒå¼ç¼“å­˜çš„äºŒçº§ç¼“å­˜è®¾è®¡
- ç†è§£åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ•°æ®ä¸€è‡´æ€§çš„å¤„ç†æ–¹æ³•
- æŒæ¡RedisåŸå­æ“ä½œçš„ä½¿ç”¨æŠ€å·§
- å­¦ä¼šè®¾è®¡é«˜å¯ç”¨çš„åˆ†å¸ƒå¼ä¼šè¯ç®¡ç†

### 6. Spring Booté«˜çº§åº”ç”¨ âš™ï¸

#### å­¦ä¹ äº®ç‚¹åˆ†æ

**æ ¸å¿ƒæ–‡ä»¶**: `WebSocketFrameworkProperties.java`, `WebSocketFrameworkConfig.java`

#### äº®ç‚¹1: åˆ†å±‚é…ç½®å±æ€§è®¾è®¡
```java
@Data
@ConfigurationProperties(prefix = "websocket.framework")
public class WebSocketFrameworkProperties {
    
    private Heartbeat heartbeat = new Heartbeat();
    private ThreadPool threadPool = new ThreadPool();
    private Session session = new Session();
    private Message message = new Message();
    private Features features = new Features();
    
    @Data
    public static class ThreadPool {
        private int coreSize = 10;
        private int maxSize = 50;
        private int queueCapacity = 1000;
        private Monitoring monitoring = new Monitoring();
    }
    
    @Data
    public static class Monitoring {
        private boolean enabled = true;
        private int initialInterval = 30;
        private HealthThresholds healthThresholds = new HealthThresholds();
    }
}
```

**å­¦ä¹ ä»·å€¼**:
- å­¦ä¹ Spring Booté…ç½®å±æ€§çš„æœ€ä½³å®è·µ
- ç†è§£åˆ†å±‚é…ç½®è®¾è®¡çš„ä¼˜åŠ¿
- æŒæ¡ç±»å‹å®‰å…¨é…ç½®çš„å®ç°æ–¹æ³•
- å­¦ä¼šè®¾è®¡å¯ç»´æŠ¤çš„é…ç½®ä½“ç³»

#### äº®ç‚¹2: æ¡ä»¶è£…é…ä¸è‡ªåŠ¨é…ç½®
```java
@Configuration
@EnableWebSocket
@EnableScheduling
@EnableConfigurationProperties(WebSocketFrameworkProperties.class)
public class WebSocketFrameworkConfig {
    
    @Bean("webSocketExecutorService")
    public ScheduledExecutorService webSocketExecutorService() {
        // æ ¹æ®é…ç½®åˆ›å»ºä¼˜åŒ–çš„çº¿ç¨‹æ± 
        OptimizedScheduledThreadPoolExecutor executor = new OptimizedScheduledThreadPoolExecutor(
            threadPoolConfig.getCoreSize(),
            new WebSocketThreadFactory("WebSocket-")
        );
        return executor;
    }
    
    @Bean("timeoutTaskWrapper")
    public TimeoutTaskWrapper timeoutTaskWrapper(@Qualifier("webSocketExecutorService") ScheduledExecutorService executor) {
        return new TimeoutTaskWrapper(executor, threadPoolConfig.getTaskTimeout());
    }
}
```

**å­¦ä¹ ä»·å€¼**:
- å­¦ä¹ Spring Bootè‡ªåŠ¨é…ç½®çš„è®¾è®¡åŸç†
- ç†è§£Beanä¾èµ–å…³ç³»çš„ç®¡ç†æ–¹æ³•
- æŒæ¡æ¡ä»¶è£…é…çš„ä½¿ç”¨æŠ€å·§
- å­¦ä¼šè®¾è®¡æ¨¡å—åŒ–çš„Spring Bootåº”ç”¨

### 7. ä»£ç è´¨é‡ä¸æœ€ä½³å®è·µ ğŸ¯

#### å­¦ä¹ äº®ç‚¹åˆ†æ

#### äº®ç‚¹1: å®Œå–„çš„å¼‚å¸¸å¤„ç†ç­–ç•¥
```java
@OnError
public void onError(Throwable error) {
    String service = webSocketSession != null ? webSocketSession.getService() : "unknown";
    String userId = webSocketSession != null ? webSocketSession.getUserId() : "unknown";
    String sessionId = webSocketSession != null ? webSocketSession.getSessionId() : "unknown";
    
    try {
        // å‘å¸ƒé”™è¯¯äº‹ä»¶
        WebSocketEvent<String> event = WebSocketEvent.onError(
            sessionId, userId, service, error.getMessage(), error
        );
        if (webSocketSession != null) {
            event.setClientIp(webSocketSession.getClientIp());
        }
        eventBus.post(event);
        
    } catch (Exception e) {
        log.error("WebSocketé”™è¯¯äº‹ä»¶å¤„ç†å¤±è´¥: service={}, userId={}", service, userId, e);
    }
}
```

**å­¦ä¹ ä»·å€¼**:
- å­¦ä¹ é˜²å¾¡æ€§ç¼–ç¨‹çš„é‡è¦æ€§
- ç†è§£å¼‚å¸¸å¤„ç†ä¸­çš„æœ€ä½³å®è·µ
- æŒæ¡å¼‚å¸¸ä¿¡æ¯çš„ç»“æ„åŒ–å¤„ç†
- å­¦ä¼šè®¾è®¡å¥å£®çš„é”™è¯¯å¤„ç†æœºåˆ¶

#### äº®ç‚¹2: ç»“æ„åŒ–æ—¥å¿—è®°å½•
```java
// ä½¿ç”¨å‚æ•°åŒ–æ—¥å¿—ï¼Œé¿å…å­—ç¬¦ä¸²æ‹¼æ¥
log.info("WebSocketè¿æ¥å»ºç«‹: service={}, userId={}, sessionId={}, clientIp={}", 
        service, userId, session.getId(), webSocketSession.getClientIp());

// æ¡ä»¶æ—¥å¿—è®°å½•ï¼Œé¿å…ä¸å¿…è¦çš„æ€§èƒ½å¼€é”€
if (log.isDebugEnabled()) {
    log.debug("ä»»åŠ¡æ‰§è¡Œå®Œæˆ: task={}, duration={}ms", taskName, duration);
}

// å¼‚å¸¸æ—¥å¿—åŒ…å«ä¸Šä¸‹æ–‡ä¿¡æ¯
log.error("WebSocketæ¶ˆæ¯å¤„ç†å¤±è´¥: service={}, userId={}, message={}", 
        service, userId, message, e);
```

**å­¦ä¹ ä»·å€¼**:
- å­¦ä¹ é«˜æ•ˆçš„æ—¥å¿—è®°å½•æ–¹æ³•
- ç†è§£æ—¥å¿—çº§åˆ«çš„æ­£ç¡®ä½¿ç”¨
- æŒæ¡ç»“æ„åŒ–æ—¥å¿—çš„è®¾è®¡åŸåˆ™
- å­¦ä¼šå¹³è¡¡æ—¥å¿—è¯¦ç»†åº¦ä¸æ€§èƒ½çš„å…³ç³»

#### äº®ç‚¹3: ä»£ç ç»„ç»‡ä¸æ¨¡å—åˆ’åˆ†
```
src/main/java/com/framework/websocket/
â”œâ”€â”€ annotation/          # æ³¨è§£å®šä¹‰
â”œâ”€â”€ config/             # é…ç½®ç±»
â”œâ”€â”€ core/               # æ ¸å¿ƒåŠŸèƒ½
â”œâ”€â”€ event/              # äº‹ä»¶ç³»ç»Ÿ
â”œâ”€â”€ handler/            # æ¶ˆæ¯å¤„ç†å™¨
â”œâ”€â”€ interceptor/        # æ‹¦æˆªå™¨
â”œâ”€â”€ monitor/            # ç›‘æ§ç»„ä»¶
â”œâ”€â”€ session/            # ä¼šè¯ç®¡ç†
â””â”€â”€ util/               # å·¥å…·ç±»
```

**å­¦ä¹ ä»·å€¼**:
- å­¦ä¹ æ¸…æ™°çš„åŒ…ç»“æ„è®¾è®¡
- ç†è§£å•ä¸€èŒè´£åŸåˆ™çš„åº”ç”¨
- æŒæ¡æ¨¡å—åŒ–è®¾è®¡çš„æ€è·¯
- å­¦ä¼šæ„å»ºå¯ç»´æŠ¤çš„ä»£ç ç»“æ„

---

## å®è·µå»ºè®®

### åˆå­¦è€…å­¦ä¹ è·¯å¾„ (1-2å‘¨)
1. **åŸºç¡€ç†è§£**
   - å…ˆç†è§£WebSocketçš„åŸºæœ¬æ¦‚å¿µå’ŒJava WebSocket API
   - å­¦ä¹ Spring Bootçš„åŸºç¡€é…ç½®å’Œè‡ªåŠ¨è£…é…æœºåˆ¶
   - äº†è§£å¹¶å‘ç¼–ç¨‹çš„åŸºæœ¬æ¦‚å¿µ

2. **ä»£ç é˜…è¯»**
   - ä»`WebSocketServer.java`å¼€å§‹ï¼Œç†è§£WebSocketç”Ÿå‘½å‘¨æœŸ
   - é˜…è¯»`WebSocketSessionManager.java`ï¼Œå­¦ä¹ ä¼šè¯ç®¡ç†
   - ç ”ç©¶é…ç½®ç±»ï¼Œç†è§£Spring Booté…ç½®çš„æœ€ä½³å®è·µ

3. **åŠ¨æ‰‹å®è·µ**
   - æ­å»ºé¡¹ç›®ç¯å¢ƒï¼Œè¿è¡Œæµ‹è¯•ç”¨ä¾‹
   - ä¿®æ”¹é…ç½®å‚æ•°ï¼Œè§‚å¯Ÿç³»ç»Ÿè¡Œä¸ºå˜åŒ–
   - ç¼–å†™ç®€å•çš„WebSocketæœåŠ¡æµ‹è¯•è¿æ¥

### ä¸­çº§å¼€å‘è€…å­¦ä¹ è·¯å¾„ (2-3å‘¨)
1. **æ¶æ„ç†è§£**
   - æ·±å…¥ç ”ç©¶äº‹ä»¶é©±åŠ¨æ¶æ„çš„å®ç°
   - å­¦ä¹ è‡ªå®šä¹‰çº¿ç¨‹æ± å’Œç›‘æ§ç³»ç»Ÿçš„è®¾è®¡
   - ç†è§£åˆ†å¸ƒå¼ä¼šè¯ç®¡ç†çš„åŸç†

2. **æºç åˆ†æ**
   - åˆ†æ`TimeoutTaskWrapper`çš„è¶…æ—¶æ§åˆ¶æœºåˆ¶
   - ç ”ç©¶`ThreadPoolMonitor`çš„è‡ªé€‚åº”ç›‘æ§ç®—æ³•
   - å­¦ä¹ `ConcurrentBiMap`çš„çº¿ç¨‹å®‰å…¨å®ç°

3. **åŠŸèƒ½æ‰©å±•**
   - å®ç°è‡ªå®šä¹‰çš„æ¶ˆæ¯å¤„ç†å™¨
   - æ·»åŠ æ–°çš„ç›‘æ§æŒ‡æ ‡
   - è®¾è®¡æ–°çš„æ‹¦æˆªå™¨åŠŸèƒ½

### é«˜çº§å¼€å‘è€…å­¦ä¹ è·¯å¾„ (3-4å‘¨)
1. **ç³»ç»Ÿä¼˜åŒ–**
   - åˆ†ææ€§èƒ½ç“¶é¢ˆï¼Œè¿›è¡Œé’ˆå¯¹æ€§ä¼˜åŒ–
   - è®¾è®¡æ›´é«˜æ•ˆçš„æ•°æ®ç»“æ„å’Œç®—æ³•
   - å®ç°æ›´æ™ºèƒ½çš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

2. **æ¶æ„æ”¹è¿›**
   - è®¾è®¡æ”¯æŒæ›´å¤§è§„æ¨¡çš„é›†ç¾¤éƒ¨ç½²æ–¹æ¡ˆ
   - å®ç°æ›´å®Œå–„çš„æ•…éšœè½¬ç§»æœºåˆ¶
   - æ·»åŠ åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªåŠŸèƒ½

3. **ç”Ÿäº§å®è·µ**
   - åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éƒ¨ç½²å’Œè°ƒä¼˜
   - å¤„ç†å®é™…çš„æ€§èƒ½å’Œç¨³å®šæ€§é—®é¢˜
   - æ€»ç»“æœ€ä½³å®è·µå’Œç»éªŒæ•™è®­

---

## è¿›é˜¶å­¦ä¹ è·¯å¾„

### æŠ€æœ¯æ·±åŒ–æ–¹å‘
1. **åˆ†å¸ƒå¼ç³»ç»Ÿ**
   - å­¦ä¹ åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•ï¼ˆRaft, Paxosï¼‰
   - ç ”ç©¶åˆ†å¸ƒå¼ç¼“å­˜çš„é«˜çº§ç‰¹æ€§
   - æŒæ¡å¾®æœåŠ¡æ¶æ„çš„è®¾è®¡åŸåˆ™

2. **æ€§èƒ½ä¼˜åŒ–**
   - æ·±å…¥JVMè°ƒä¼˜å’Œåƒåœ¾å›æ”¶å™¨é€‰æ‹©
   - å­¦ä¹ ç½‘ç»œç¼–ç¨‹çš„é«˜çº§æŠ€å·§ï¼ˆNetty, NIOï¼‰
   - æŒæ¡é«˜å¹¶å‘ç³»ç»Ÿçš„è®¾è®¡æ¨¡å¼

3. **å¯è§‚æµ‹æ€§**
   - å­¦ä¹ ç°ä»£ç›‘æ§ç³»ç»Ÿï¼ˆPrometheus, Grafanaï¼‰
   - æŒæ¡åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼ˆJaeger, Zipkinï¼‰
   - ç ”ç©¶APMå·¥å…·çš„å®ç°åŸç†

### ç›¸å…³é¡¹ç›®æ¨è
1. **Netty** - å­¦ä¹ é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹
2. **Spring Cloud** - å­¦ä¹ å¾®æœåŠ¡æ¶æ„
3. **Apache Kafka** - å­¦ä¹ åˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿ
4. **Redis Cluster** - å­¦ä¹ åˆ†å¸ƒå¼ç¼“å­˜
5. **Elasticsearch** - å­¦ä¹ åˆ†å¸ƒå¼æœç´¢å¼•æ“

### å­¦ä¹ èµ„æºæ¨è
1. **ä¹¦ç±**
   - ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹
   - ã€Šåˆ†å¸ƒå¼ç³»ç»ŸåŸç†ä¸èŒƒå‹ã€‹
   - ã€Šé«˜æ€§èƒ½MySQLã€‹
   - ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹

2. **åœ¨çº¿èµ„æº**
   - Springå®˜æ–¹æ–‡æ¡£å’Œç¤ºä¾‹
   - Rediså®˜æ–¹æ–‡æ¡£
   - Javaå¹¶å‘ç¼–ç¨‹ç½‘
   - é«˜å¯ç”¨æ¶æ„æŠ€æœ¯ç¤¾åŒº

3. **å®è·µå¹³å°**
   - GitHubå¼€æºé¡¹ç›®
   - ä¸ªäººåšå®¢å’ŒæŠ€æœ¯åˆ†äº«
   - æŠ€æœ¯ä¼šè®®å’Œè®ºå›
   - å†…éƒ¨æŠ€æœ¯åˆ†äº«ä¼š

---

## æ€»ç»“

è¿™ä¸ªWebSocketæ¡†æ¶é¡¹ç›®æ˜¯ä¸€ä¸ª**å­¦ä¹ ä»·å€¼æé«˜**çš„ä¼ä¸šçº§å®æˆ˜é¡¹ç›®ã€‚é€šè¿‡ç³»ç»Ÿå­¦ä¹ è¿™ä¸ªé¡¹ç›®ï¼Œä½ å¯ä»¥ï¼š

1. **æŒæ¡ä¼ä¸šçº§WebSocketåº”ç”¨å¼€å‘**çš„å®Œæ•´æŠ€èƒ½æ ˆ
2. **ç†è§£åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡**çš„æ ¸å¿ƒåŸç†å’Œå®è·µæ–¹æ³•
3. **å­¦ä¼šé«˜å¹¶å‘ç³»ç»Ÿçš„è®¾è®¡**å’Œæ€§èƒ½ä¼˜åŒ–æŠ€å·§
4. **æŒæ¡ç³»ç»Ÿç›‘æ§å’Œè¿ç»´**çš„æœ€ä½³å®è·µ
5. **æå‡ä»£ç è´¨é‡å’Œæ¶æ„è®¾è®¡**èƒ½åŠ›

å»ºè®®æŒ‰ç…§ä¸Šè¿°å­¦ä¹ è·¯å¾„å¾ªåºæ¸è¿›ï¼Œæ—¢è¦ç†è§£ç†è®ºåŸç†ï¼Œä¹Ÿè¦åŠ¨æ‰‹å®è·µï¼Œæ›´è¦æ€è€ƒå¦‚ä½•åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨è¿™äº›æŠ€æœ¯å’Œè®¾è®¡æ€è·¯ã€‚

---

*å­¦ä¹ æŒ‡å—ç¼–å†™æ—¶é—´: 2025-08-01*  
*æŠ€æœ¯å¯¼å¸ˆ: Claude*